{% extends "base.html" %}

{% block title %}首页 - 微信公众号发布工具{% endblock %}

{% block content %}
<div class="card">
    <h1>微信公众号发布工具</h1>
    <p class="text-secondary">管理文章、自动发布到微信公众号</p>
</div>

<div class="grid">
    <div class="card">
        <h3>文章统计</h3>
        <div id="stats">
            <p>加载中...</p>
        </div>
    </div>
    
    <div class="card">
        <h3>快速操作</h3>
        <div class="flex gap-2">
            <a href="/articles" class="btn btn-primary">文章列表</a>
            <a href="/generate" class="btn btn-primary">AI 生成</a>
            <button onclick="refreshStats()" class="btn">刷新</button>
        </div>
    </div>
</div>

<div class="card">
    <h3>最近发布</h3>
    <div id="recent-posts">
        <p>加载中...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadStats() {
    try {
        const articles = await api('/api/articles');
        const logs = await api('/api/publish/logs');
        
        const draftCount = articles.filter(a => a.status === 'draft').length;
        const publishedCount = articles.filter(a => a.status === 'published').length;
        
        document.getElementById('stats').innerHTML = `
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value">${articles.length}</span>
                    <span class="stat-label">总文章</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${draftCount}</span>
                    <span class="stat-label">草稿</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${publishedCount}</span>
                    <span class="stat-label">已发布</span>
                </div>
            </div>
        `;
        
        const recentHtml = logs.slice(0, 5).map(log => `
            <div class="log-item">
                <span>文章 #${log.article_id}</span>
                <span class="status-${log.mode}">${log.mode === 'draft' ? '草稿' : '发布'}</span>
                <span>${new Date(log.published_at).toLocaleString()}</span>
            </div>
        `).join('');
        
        document.getElementById('recent-posts').innerHTML = recentHtml || '<p>暂无发布记录</p>';
    } catch (e) {
        document.getElementById('stats').innerHTML = '<p>加载失败</p>';
        document.getElementById('recent-posts').innerHTML = '<p>加载失败</p>';
    }
}

function refreshStats() {
    loadStats();
}

loadStats();
</script>
{% endblock %}
